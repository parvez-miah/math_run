name: Process Math Questions

on:
  workflow_dispatch:
    inputs:
      folders_to_process:
        description: 'Comma-separated folder names to process (leave empty for all)'
        required: false
        default: ''
      batch_size:
        description: 'Number of images to process before break'
        required: false
        default: '20'
      break_minutes:
        description: 'Break duration in minutes'
        required: false
        default: '20'

jobs:
  process-questions:
    runs-on: ubuntu-latest
    timeout-minutes: 720  # 12 hours max
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true # Added in case images are stored in LFS
      
      - name: Display Workflow Inputs
        run: |
          echo "üìÇ Workflow Inputs:"
          echo "   - Folders to process: '${{ github.event.inputs.folders_to_process }}'"
          echo "   - Batch Size: ${{ github.event.inputs.batch_size }}"
          echo "   - Break Duration: ${{ github.event.inputs.break_minutes }} minutes"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          echo "üêç Installing dependencies..."
          python -m pip install --upgrade pip
          pip install requests
          echo "‚úÖ Dependencies installed:"
          pip list
      
      - name: Verify folder_contexts.json
        run: |
          echo "üîç Verifying 'folder_contexts.json'..."
          if [ ! -f "folder_contexts.json" ]; then
            echo "‚ùå folder_contexts.json not found!"
            exit 1
          fi
          echo "‚úÖ folder_contexts.json found"
          ls -lh folder_contexts.json
          echo "--- Content Start ---"
          cat folder_contexts.json
          echo "--- Content End ---"
      
      - name: Verify Images Folders
        run: |
          echo "üñºÔ∏è Verifying 'Images' folder..."
          if [ ! -d "Images" ]; then
            echo "‚ùå Images folder not found!"
            exit 1
          fi
          echo "‚úÖ Images folder found. Listing contents:"
          # List subdirectories
          ls -l Images/
          # List contents of subdirectories (up to 50 items for brevity)
          echo "--- Subfolder Contents (sample) ---"
          ls -R Images/ | head -n 50
          echo "-----------------------------------"
      
      - name: Process Questions
        env:
          GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
        run: |
          echo "üöÄ Starting question processing..."
          echo "üìä Configuration:"
          echo "   - Batch Size: ${{ github.event.inputs.batch_size }}"
          echo "   - Break Duration: ${{ github.event.inputs.break_minutes }} minutes"
          
          # Run with -u flag for unbuffered output to see all logs in real-time
          python -u process_questions.py
      
      - name: Prepare Artifacts
        if: success()
        run: |
          echo "üì¶ Preparing artifacts..."
          echo "   Current directory: $(pwd)"
          if [ ! -d "output_data" ]; then
            echo "‚ö†Ô∏è No 'output_data' directory found. Nothing to zip."
            exit 0
          fi
          cd output_data
          echo "   Inside 'output_data' directory. Contents:"
          ls -l
          echo "   Zipping subfolders..."
          for folder in */; do
            if [ -d "$folder" ]; then
              folder_name="${folder%/}"
              echo "   - Zipping: $folder_name"
              zip -r "${folder_name}.zip" "$folder_name"
            fi
          done
          echo "‚úÖ Zipping complete. Final zip files:"
          ls -lh *.zip
      
      - name: Upload Output Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: processed-questions-${{ github.run_number }}
          path: output_data/*.zip
          retention-days: 30
      
      - name: Generate Summary Report
        if: success()
        run: |
          echo "Generating summary report..."
          echo "# üìä Processing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚úÖ Successfully Processed Folders" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ ! -d "output_data" ]; then
            echo "No 'output_data' directory found to summarize." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          for folder in output_data/*/; do
            if [ -d "$folder" ] && [ -f "${folder}full.json" ]; then
              folder_name=$(basename "$folder")
              total_questions=$(cat "${folder}full.json" | grep -o '"id":' | wc -l)
              file_size=$(du -h "${folder}full.json" | cut -f1)
              
              echo "### üìÅ $folder_name" >> $GITHUB_STEP_SUMMARY
              echo "- **Total Questions:** $total_questions" >> $GITHUB_STEP_SUMMARY
              echo "- **File Size:** $file_size" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "## üì• Download Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts are available in the **Actions** tab under this workflow run." >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Summary report generated."
      
      - name: Cleanup on Failure
        if: failure()
        run: |
          echo "‚ùå Workflow failed. Check logs for details."
          echo "--- Current Directory State ---"
          pwd
          ls -l
          echo "--- Output Data State (if exists) ---"
          ls -R output_data/ || echo "No output_data found on failure."